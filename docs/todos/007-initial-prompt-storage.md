---
title: セッション開始時の初期プロンプトを保存し、Web管理コンソールに表示する
status: in_progress
---

# 007: セッション開始時の初期プロンプトを保存し、Web管理コンソールに表示する

## 概要

### 解決したい問題

現在のWeb管理コンソールのセッション一覧画面では、セッションIDとタイムスタンプのみが表示されており、どのような作業を行っているセッションなのかが判別しづらい。ユーザーがセッションの内容を把握するためには、各セッションをクリックして詳細を確認する必要があり、使い勝手が悪い。

この問題を解決するため、セッション開始時の最初のプロンプト（ユーザーがClaudeに送った最初のメッセージ）をデータベースに保存し、セッション一覧画面に表示することで、各セッションの目的や内容を一目で把握できるようにする。

## 手順

### 1. データベースのマイグレーション

- [x] 新しいマイグレーションファイルを作成: `000007_add_initial_prompt_to_sessions.up.sql` / `.down.sql`
- [x] `sessions` テーブルに `initial_prompt TEXT` カラムを追加
- [x] sqlc のクエリを更新して、initial_prompt を含めたセッション作成・取得処理を追加
- [x] `sqlc generate` を実行してコード生成

### 2. サーバーサイドの変更

#### 2.1 セッション作成時の初期プロンプト保存

- [x] `internal/slack/handler.go` の `handleAppMention` メソッドを修正
  - [x] `removeBotMention` で取得したテキストを初期プロンプトとして保存
- [x] `internal/session/manager.go` の `CreateSessionWithResume` メソッドを修正
  - [x] 初期プロンプトを受け取る引数を追加
  - [x] データベースへのセッション作成時に初期プロンプトを保存
- [ ] `internal/process/claude.go` の `NewClaudeProcess` 関数のシグネチャを更新（必要に応じて）

#### 2.2 API エンドポイントの更新

- [x] `/api/sessions` エンドポイントのレスポンスに `initial_prompt` フィールドを追加
- [x] `/api/threads/:thread_id/sessions` エンドポイントのレスポンスにも同様に追加
- [x] セッション取得時のクエリを更新して initial_prompt を含める

### 3. フロントエンドの変更

#### 3.1 TypeScript インターフェースの更新

- [ ] `web/src/components/SessionList.tsx` の `Session` インターフェースに `initial_prompt?: string` を追加
- [ ] 他のセッション関連コンポーネントのインターフェースも同様に更新

#### 3.2 UI の改善

- [ ] セッション一覧での初期プロンプト表示方法を決定
  - オプション1: プレーンテキストとして最初の1-2行を表示
  - オプション2: Markdownパーサーを通して整形して表示
  - オプション3: 最初の100文字程度を切り詰めて表示し、ホバーで全文表示
- [ ] セッションカードのレイアウトを調整して初期プロンプトを含める
- [ ] 初期プロンプトが長い場合の表示制御（truncate、展開/折りたたみなど）

#### 3.3 ユーザビリティの向上

- [ ] 初期プロンプトが空の既存セッションへの対応（"プロンプトなし" などの表示）
- [ ] 検索機能の追加を検討（初期プロンプトでのフィルタリング）

## 実装上の注意点

1. **既存データとの互換性**: 既存のセッションには initial_prompt が NULL になるため、フロントエンドで適切に処理する
2. **プライバシー**: 初期プロンプトには機密情報が含まれる可能性があるため、適切なアクセス制御を維持
3. **パフォーマンス**: 大量のセッションがある場合の一覧表示パフォーマンスに注意
4. **文字数制限**: 初期プロンプトが非常に長い場合の保存・表示方法を考慮
5. **セッション再開時の扱い**: resumeセッションも新しいセッションとして扱い、そのセッションを開始したプロンプトを保存する

## テスト項目

- [ ] 新規セッション作成時に初期プロンプトが正しく保存されることを確認
- [ ] 既存セッション（initial_prompt = NULL）の表示が崩れないことを確認
- [ ] 長い初期プロンプトの表示が適切に制御されることを確認
- [ ] セッション再開時の動作確認（resumeセッションでもそのセッションを開始したプロンプトが保存される）