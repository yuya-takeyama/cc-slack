---
title: データベース統合と拡張機能の実装
status: in_progress
---

# データベース統合と拡張機能の実装

PR #17 で基盤は作成されたが、実際の統合がまだ完了していない。このタスクでデータベース機能と関連する拡張機能を依存関係を考慮して実装する。

## Phase 1: データベース基盤の完成（前提条件）

### 1.1 データベース基盤の動作確認と修正
- [ ] SQLiteデータベース統合の動作確認（internal/database/）
- [ ] golang-migrateによるスキーマ管理の動作確認（migrations/）
- [ ] sqlcによる型安全なクエリ生成の動作確認（internal/db/）
- [ ] データベース初期化とマイグレーション実行の動作確認

### 1.2 main.go の統合
- [ ] データベース初期化処理の修正
- [ ] エラーハンドリングの実装
- [ ] 起動時のデータベース接続確認

### 1.3 基本的なテスト
- [ ] データベース操作のユニットテスト
- [ ] マイグレーションのテスト

## Phase 2: セッション永続化（Phase 1 に依存）

### 2.1 DBManagerの完全実装
- [ ] `internal/session/db_manager.go` の実装完了
- [ ] SessionManager インターフェースの完全実装
- [ ] メモリベースのManagerとの統合

### 2.2 セッション情報の永続化
- [ ] セッション情報のDB保存
- [ ] スレッドとセッションの紐付け管理
- [ ] セッション統計情報の記録（コスト、トークン数、実行時間）

### 2.3 テスト
- [ ] DBManagerの統合テスト
- [ ] セッション永続化のE2Eテスト

## Phase 3: セッション再開機能（Phase 2 に依存）

### 3.1 ResumeManagerの実装
- [ ] ResumeManagerによる再開判定ロジック（internal/process/resume.go）
- [ ] 再開可能時間の設定（デフォルト1時間）
- [ ] 既存セッションの自動検出

### 3.2 Claude Code との統合
- [ ] 同一スレッド内でのセッション継続（--resume オプション）
- [ ] 再開時のコンテキスト復元
- [ ] エラーハンドリング

### 3.3 テスト
- [ ] セッション再開のE2Eテスト
- [ ] タイムアウト境界のテスト

## Phase 4: 複数ワーキングディレクトリ対応（Phase 2 に依存）

### 4.1 データモデルの拡張
- [ ] working_directories テーブルの活用
- [ ] チャンネルとワーキングディレクトリの紐付け

### 4.2 選択ロジックの実装
- [ ] WorkspaceSelector の実装
- [ ] メンション時のproject指定パース
- [ ] デフォルト処理

### 4.3 設定との統合
- [ ] Viper設定との連携
- [ ] 環境変数サポート

## Phase 5: Webマネジメントコンソール（Phase 2 に依存）

### 5.1 バックエンドAPI
- [ ] RESTful API の設計と実装
- [ ] セッション一覧エンドポイント
- [ ] 統計情報エンドポイント
- [ ] Server-Sent Events for リアルタイム更新

### 5.2 フロントエンドUI
- [ ] 基本的なHTML/CSSレイアウト
- [ ] セッション履歴の表示
- [ ] 統計情報のビジュアライゼーション
- [ ] リアルタイムモニタリング

### 5.3 認証とセキュリティ
- [ ] Basic認証の実装
- [ ] CORS設定
- [ ] Rate limiting

## 実装上の注意事項

### 現在の未完成実装
- `cmd/cc-slack/main.go` にデータベース初期化のコードがあるが動作していない
- `internal/session/db_manager.go` に不完全な実装がある

### 実装の優先順位
1. **必須**: Phase 1-3（データベース基盤 → セッション永続化 → セッション再開）
2. **推奨**: Phase 4（複数ワーキングディレクトリ）
3. **オプション**: Phase 5（Webコンソール）

### 既存実装との整合性
- Viper設定管理は実装済みなので活用する
- メモリベースのSessionManagerと互換性を保つ
- 既存のテストが通ることを確認しながら進める